import traceback

from openpyxl import Workbook
from openpyxl.cell import Cell, MergedCell
from bs4 import BeautifulSoup
from openpyxl.styles import PatternFill
from openpyxl.utils.cell import get_column_letter
from openpyxl.styles.borders import Border, Side
from openpyxl.styles import Alignment

ff = '<table class="first iksweb" id="first_table">\n\n                        <tbody id="earthWorks_1">\n                    <tr><td colspan="6" style="padding: 0;"><input id="zagolovok_1" style="width: 100%; height: 100%; border:  0;" autocomplete="off" value="123">\n                               </td><td colspan="4"><button id="del_razdel_1" type="button" class="btn-primary"> Удалить раздел</button></td>\n                    </tr>\n                        <tr style="background-color: #fce1b3">\n                            <td rowspan="2" class="tehstolbec">Тех столбец</td>\n                            <td>№</td>\n                            <td rowspan="2" style="font-weight: bold;">Наименование</td>\n                            <td colspan="4" style="font-weight: bold;">Стоимость</td>\n                            <td colspan="4" style="font-weight: bold;">Справочная информация</td>\n                            <td colspan="8" style="display:none" class="pto">Аналитический блок</td>\n                        </tr>\n\n                        <tr style="background-color: #fce1b3">\n                            <td style="font-weight: bold;">п/п</td>\n                            <td style="font-weight: bold;">Ед.изм.</td>\n                            <td style="font-weight: bold;">Кол-во</td>\n                            <td style="font-weight: bold;">Цена</td>\n                            <td style="font-weight: bold;">Всего</td>\n                            <td rowspan="1" style="font-weight: bold;">Тр-затр (чел-дн)</td>\n                            <td rowspan="1" style="font-weight: bold;">Столбец для анализа</td>\n                            <td rowspan="1" style="font-weight: bold;"></td>\n                            <td rowspan="1" style="font-weight: bold;">Примечание</td>\n                            <td style="display:none" class="pto">Кол-во</td>\n                            <td style="display:none" class="pto">Цена руб-ед</td>\n                            <td style="display:none" class="pto">Всего</td>\n                            <td style="display:none" class="pto">Тр-затр (чел-дн)</td>\n                            <td style="display:none" class="pto">Стоимость дня рабочего</td>\n                        </tr>\n                        </tbody>\n                        <tbody id="earthWorks_costWork_1">\n                        <tr>\n                            <td style="border-right: none;"></td>\n                            <td contenteditable="false" style="border-left: none; border-right: none;"></td>\n                            <td contenteditable="false" id="earthWorks_costWork_addLine_1" style="font-weight: bold; border-left: none;" colspan="4" onmouseover="showButton(event, this)" onmouseout="closeButton(event,this)">\n                            Стоимость работ\n                            <div style="display: none;"><button type="button" onclick="addLine(event,this)">addLine</button></div>\n                            </td>\n                            <td contenteditable="false"></td>\n\n\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true" style="display:none" class="pto"></td>\n                            <td contenteditable="true" style="display:none" class="pto"></td>\n                            <td contenteditable="true" style="display:none" class="pto"></td>\n                            <td contenteditable="true" style="display:none" class="pto"></td>\n                            <td contenteditable="true" style="display:none" class="pto"></td>\n                        </tr>\n                    </tbody><tbody id="earthWorks_costMaterial_1">\n                        <tr>\n                        <td style="border-right: none;"></td>\n                            <td contenteditable="false" style="border-left: none; border-right: none;"></td>\n                            <td contenteditable="false" id="earthWorks_costMaterial_addLine_1" style="font-weight: bold; border-left: none;" colspan="4" onmouseover="showButton(event, this)" onmouseout="closeButton(event,this)">\n                            Стоимость материала\n                            <div style="display: none;"><button onclick="addLine(event,this)">addLine</button></div>\n                            </td>\n                            <td contenteditable="false"></td>\n\n\n                            <td contenteditable="false" colspan="2" style="font-weight: bold;"> Ед изм расчётные </td>\n\n                            <td contenteditable="false" style="font-weight: bold;"> Ед изм (М2) для окраски </td>\n\n                            <td contenteditable="true"></td>\n\n                            <td contenteditable="false" style="display:none" class="pto">Закупка по счету - ед изм расчётные</td>\n                            <td contenteditable="false" style="display:none" class="pto">Остаток закупки</td>\n                            <td contenteditable="false" style="display:none" class="pto">ед изм к закупке</td>\n                            <td contenteditable="false" style="display:none" class="pto">руб-ед</td>\n                            <td contenteditable="false" style="display:none" class="pto"></td>\n                            <td contenteditable="false" style="display:none" class="pto">Счёта</td>\n                            <td contenteditable="false" style="display:none" class="pto">Срок поставки</td>\n                            <td contenteditable="false" style="display:none" class="pto">ПРИМЕЧАНИЕ</td>\n                        </tr>\n                    </tbody>\n\n                    <tbody id="earthWorks_Special_1">\n                    <tr>\n                    <td style="border-right: none;"></td>\n                            <td contenteditable="false" style="border-left: none; border-right: none;"></td>\n                             <td contenteditable="false" id="earthWorks_Special_addLine_1" style="font-weight: bold; border-left: none;" colspan="4" onmouseover="showButton(event, this)" onmouseout="closeButton(event,this)">\n                            Стоимость спецтехники\n                            <div style="display: none;"><button onclick="addLine(event,this)">addLine</button></div>\n                            </td>\n                            <td contenteditable="false"></td>\n\n\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n\n                            <td contenteditable="true"></td>\n\n                            <td contenteditable="false" style="display:none" class="pto">Стоимость аренды</td>\n                            <td contenteditable="false" style="display:none" class="pto">Телефон</td>\n                            <td contenteditable="false" style="display:none" class="pto">Счет</td>\n                            <td contenteditable="false" style="display:none" class="pto">Срок</td>\n\n                        </tr>\n\n                    </tbody>\n\n                     <tbody id="earthWorks_Total_1">\n                        <tr>\n                        <td style="border-right: none;"></td>\n                            <td contenteditable="false" style="border-left: none; border-right: none;"></td>\n                            <td contenteditable="false" style="font-weight: bold;border-left: none;" colspan="4"> Итого\n                            </td>\n\n\n                            <td contenteditable="false"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true" style="display:none" class="pto"></td>\n                            <td contenteditable="true" style="display:none" class="pto"></td>\n                            <td contenteditable="true" style="display:none" class="pto"></td>\n                            <td contenteditable="true" style="display:none" class="pto"></td>\n\n\n                        </tr>\n                        <tr id="stroka">\n                        <td class="tehstolbec"></td>\n                            <td contenteditable="false">1</td>\n                            <td contenteditable="false" style="font-weight: bold;">\n                                Накладные расходы\n                            </td>\n                            <td contenteditable="false">%</td>\n                            <td contenteditable="true" class="percent"></td>\n                            <td contenteditable="true"></td>\n\n\n\n                            <td contenteditable="false"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n\n\n                        </tr>\n\n                        <tr id="stroka">\n                        <td class="tehstolbec"></td>\n                            <td contenteditable="false">2</td>\n                            <td contenteditable="false" style="font-weight: bold;">\n                                Вспомогательные материалы\n                            </td>\n                            <td contenteditable="false">%</td>\n                            <td contenteditable="true" class="percent"></td>\n                            <td contenteditable="true"></td>\n\n\n\n                            <td contenteditable="false"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto" <="" td="">\n                            </td><td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n\n\n                        </tr>\n\n                        <tr id="stroka">\n                        <td class="tehstolbec"></td>\n                            <td contenteditable="false">3</td>\n                            <td contenteditable="false" style="font-weight: bold;">\n                                Транспортные расходы\n                            </td>\n                            <td contenteditable="false">%</td>\n                            <td contenteditable="true" class="percent"></td>\n                            <td contenteditable="true"></td>\n\n\n\n                            <td contenteditable="false"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n                            <td contenteditable="true" style="display:none" class="costWork_role_boss pto"></td>\n\n\n                        </tr>\n\n                        <tr id="stroka">\n                        <td class="tehstolbec"></td>\n                            <td contenteditable="false">4</td>\n                            <td contenteditable="false" style="font-weight: bold; text-align: right">\n                                ВСЕГО:\n                            </td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n\n\n\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n\n                        </tr>\n                        <tr id="stroka">\n                        <td class="tehstolbec"></td>\n                            <td contenteditable="false">5</td>\n                            <td contenteditable="false" style="font-weight: bold;">\n                                В том числе НДС - 20% за нал от материалов\n                            </td>\n                            <td contenteditable="false">%</td>\n                            <td contenteditable="true" class="percent"></td>\n                            <td contenteditable="true"></td>\n\n\n                            <td contenteditable="false"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n                            <td contenteditable="true"></td>\n\n                        </tr>\n                    </tbody>\n\n                    <tbody id="result_total">\n                    <tr class="blank_row">\n                        <td colspan="100%"></td>\n                    </tr>\n                        <tr>\n                        <td class="tehstolbec"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false" style="font-weight: bold; text-align: right">\n                                ВСЕГО:\n                            </td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                        </tr>\n                        <tr>\n                        <td class="tehstolbec"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false" style="font-weight: bold;">\n                                В том числе НДС - 20% за нал от материалов\n                            </td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                            <td contenteditable="false"></td>\n                        </tr>\n                    </tbody>\n                    </table>'
ff=ff.replace('colspan="100%"','')
ff=ff.replace('\n                             ','')
ff=ff.replace('\n                    ','')


workbook = Workbook()
sheet = workbook.active
with_column={}


soup = BeautifulSoup(ff, 'lxml')
table = soup.find_all('table')[0]
thin_border = Border(left=Side(style='thin'),
                     right=Side(style='thin'),
                     top=Side(style='thin'),
                     bottom=Side(style='thin'))

try:
    row_marker = 1
    for row in table.find_all('tr'):
        column_marker = 1
        print(row)
        background_color=""
        if row.get("style") and row.get("style").find("background-color") != -1:
            background_color=row.get("style")[row.get("style").find("background-color: ")+19:]
        columns = row.find_all('td')
        for column in columns:
            print(column)
            print("column.get_text()",column.get_text())


            if column.div:
                column.div.decompose()
            if row_marker==4 and column_marker==3:
                ...
            while isinstance(sheet.cell(row=row_marker, column=column_marker), MergedCell):
                column_marker+=1
            sheet.cell(row=row_marker, column=column_marker, value=column.get_text())
            sheet.cell(row=row_marker, column=column_marker).border = thin_border
            sheet.cell(row=row_marker, column=column_marker).alignment = Alignment(horizontal='center')
            print(with_column)
            print(get_column_letter(column_marker))
            print(column.get_text())
            print(len(column.get_text()))
            # if get_column_letter(column_marker)=="J":
            #     pass
            text_len=len(column.get_text())
            if text_len!=0 and with_column.setdefault(get_column_letter(column_marker),text_len+2):
                if with_column[get_column_letter(column_marker)]<=text_len+2:
                    with_column[get_column_letter(column_marker)] = text_len+2
                    sheet.column_dimensions[get_column_letter(column_marker)].width = text_len+2
            if background_color!="":
                sheet[row_marker][column_marker-1].fill = PatternFill(start_color=background_color, end_color=background_color, fill_type="solid")

            if column.get("colspan") or column.get("rowspan"):

                merge_column = column_marker
                merge_row = row_marker
                if column.get("colspan"):
                    print(column.get("colspan"))
                    merge_column += int(column.get("colspan"))-1
                if column.get("rowspan"):
                    merge_row += int(column.get("rowspan"))-1

                sheet.merge_cells(start_row=row_marker, start_column=column_marker, end_row=int(merge_row), end_column=int(merge_column))
            if column.get("colspan"):
                column_marker += int(column.get("colspan"))-1
            # if column.get("rowspan"):
            #     row_marker += int(column.get("rowspan"))-1

            column_marker += 1
        row_marker += 1
    workbook.save(filename="converter_html_in_xlsx.xlsx")
except:
    print(traceback.format_exc())
    workbook.save(filename="converter_html_in_xlsx.xlsx")
    print(traceback.format_exc())

print(with_column)