<div class="panel-body">
    <div class="row">
        <div class="col-lg-12">
            <form role="form" id="formFrame">

                <div class="form-group">
                <label ></label>
                <div class="form-group">
                    <label>Наименнование объекта</label>
                    <input value="{{ getTechTaskName.NameTechTask }}"
                           class="form-control" readonly>
                </div>
                <div class="form-group">
                <div id="div_name_razdel">
                    <label>Добавление раздела</label>
                    <div id="div1">
                    <input id="select_one" type="text" name="example" list="ListRazdel" value="" class="form-control">
                    <datalist id="ListRazdel">
                    </datalist>
                    </div>

                    </div>
                    </div>

                    <button id='add_razdel' type="button" class="btn btn-primary"> Добавить раздел</button>
{#                    <button id='del_razdel' type="button" class="btn btn-primary"> Удалить раздел</button>#}


                </div>

                <div class="style_table table-responsive-pto" id='style_table' style="display:none;">
                    <table class="first iksweb" id="first_table" >

                    </table>
                </div>
            </form>
        </div>
    </div>
</div>

<script>

const table = document.getElementById('first_table');

    let coll_table = 1;
    let arr_coll_table = [1];
    let id_count = 1;
    let arr_id_count = [1];

    function objLine(id_count, forTable) {
        let addLineObj = new Object();
        addLineObj = {
            'earthWorks_costWork': `<tr id = "stroka_${id_count}">
<td contenteditable="false"><button type = "button" aria-hidden="true" class="delbtn fa fa-trash-o" id="delbtn_${id_count}"></button></td>


                            <td contenteditable="false">

                            </td>
                            <td contenteditable="true" style="padding: 0;">

                            <div id="div_costWork_${id_count}" style = "border: 0; padding: 0; margin: 0; width: 100%; height: 100%;">
                            <input id = 'input_costWork_${id_count}' type="text"  name="example" list="datalist_costWork_${id_count}"  value= ''   style = "width: 100%; height: 100%; border:  0; background: radial-gradient(farthest-corner at 50% 50%, white, #e5ebf2);">
                            <datalist id="datalist_costWork_${id_count}">
                            </datalist>
                            </div></td>
                            <td contenteditable="true"></td>


                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"><button type = "button" aria-hidden="true" class="delbtn fa fa-trash-o" id="delbtn_${id_count}"></button></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        </tr>`,
            'earthWorks_costMaterial': `<tr id = "stroka_${id_count}">
<td contenteditable="false"><button type = "button" aria-hidden="true" class="delbtn fa fa-trash-o" id="delbtn_${id_count}"></button></td>
<td contenteditable="false"></td>
                            <td contenteditable="true" style="padding: 0;">
                            <div id="div_costMaterial_${id_count}" style = "border: 0; padding: 0; margin: 0; width: 100%; height: 100%;">
                            <input id = 'input_costMaterial_${id_count}' type="text"  name="example" list="datalist_costMaterial_${id_count}"  value= ''   style = "width: 100%; height: 100%; border:  0; background: radial-gradient(farthest-corner at 50% 50%, white, #e5ebf2);">
                            <datalist id="datalist_costMaterial_${id_count}">
                            </datalist>
                            </div>
                            </td>
                            <td contenteditable="true"></td>


                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"><button type = "button" aria-hidden="true" class="delbtn fa fa-trash-o" id="delbtn_${id_count}"></button></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        </tr>`,
            'earthWorks_Special': `<tr id = "stroka_${id_count}">
<td contenteditable="false"><button type = "button" aria-hidden="true" class="delbtn fa fa-trash-o" id="delbtn_${id_count}"></button></td>
<td contenteditable="false"></td>
                            <td contenteditable="true" style="padding: 0;">
                            <div id="div_Special_${id_count}" style = "border: 0; padding: 0; margin: 0; width: 100%; height: 100%;">
                            <input id = 'input_Special_${id_count}' type="text"  name="example" list="datalist_Special_${id_count}"  value= ''   style = "width: 100%; height: 100%; border:  0; background: radial-gradient(farthest-corner at 50% 50%, white, #e5ebf2);">
                            <datalist id="datalist_Special_${id_count}">
                            </datalist>
                            </div>
                            </td>
                            <td contenteditable="true"></td>


                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="false"><button type = "button" aria-hidden="true" class="delbtn fa fa-trash-o" id="delbtn_${id_count}"></button></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        <td contenteditable="true"></td>
                        </tr>`,
        };

        //console.warn('!!!',addLineObj[forTable])
        return addLineObj[forTable];
    }


let time
function showButton (event, elem){
{#console.warn(document.getElementsByTagName('NameTechTask'))#}
{#time = setTimeout(function (){#}
elem = elem.id;
{#console.warn('child = ',elem, ' ', document.getElementById(elem).childNodes[1])#}
document.getElementById(elem).childNodes[1].style.display = "block";

//}, 500)
}

function closeButton (event,elem){
{#if (time){clearTimeout(time)}#}
elem = elem.id;
document.getElementById(elem).childNodes[1].style.display = "none";
}


function addLine(event, element){

element = element.parentElement.parentElement.parentElement.parentElement;
let element_id = element.id;
let forObj = element_id.slice(0, element_id.lastIndexOf('_'))
$(element).append(objLine(id_count, forObj))
forObj = forObj.slice(forObj.indexOf('_')+1)
$(`#div_${forObj}_${id_count}`).delegate(":input", "input", function (e) {
let type = forObj;
let id_count=e.target.id.slice(e.target.id.lastIndexOf('_')+1)
console.log("stroka = " + " #datalist_" + forObj + "_"+id_count)
    var options = $("#datalist_" + forObj + "_"+id_count)[0].options;
    console.log("options = " + options)
    if (options.length != 0 && options[options.length - 1].value == $(this).val()) {
        {# Определить type по target.id#}

        if ($(this).val().indexOf("Добавить в список \"") != -1) {
            set_setSuggest(type, $(this).val().replace("Добавить в список \"", "").slice(0, -1),`datalist_${forObj}_${id_count}`)
            $(`#input_${forObj}_${id_count}`).val($(this).val().replace("Добавить в список \"", "").slice(0, -1));
        }
        return
    }
    set_options_datalist(type, e.target.value,"datalist_" + forObj +"_"+id_count, 5)

});
console.warn('counterTr(); из AddLine')
counterTr();
            id_count++;
            arr_id_count.push(id_count);
}



function set_options_datalist(customer_id, search,id_datalist, count = 10) {
    $.ajax({
        method: 'POST',
        url: "/suggest/getSuggest",
        headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json',
            "Authorization": localStorage.getItem('Authorization')
        },
        data: `{"customer_id":"${customer_id}","search": "${search}","count":${count}}`,
        success: function (ingredients) {
        console.log("success")

            for (var i in ingredients) {

                {#console.log("search",search)#}
                {#console.log("ingredients[i].value_table",ingredients[i].value_table)#}

                if (ingredients[i].value_table == search) {
                {#console.log("return")#}

                    return
                }
            }
                {#console.log("return2")#}

            $(`#${id_datalist}`).empty();
            for (var i in ingredients) {
                $(`<option id="${i}" />`).html(ingredients[i].value_table).appendTo(`#${id_datalist}`);
                if (i == ingredients.length - 1) {
                    $(`<option/>`).html(`Добавить в список "${search}"`).appendTo(`#${id_datalist}`);
                }

            }
        },
        error: function (error) {
            $(`#${id_datalist}`).empty();
            $(`<option/>`).html(`Добавить в список "${search}"`).appendTo(`#${id_datalist}`);

        },
    });
}

function set_setSuggest(customer_id, add_value,id_datalist) {
    $.ajax({
        method: 'POST',
        url: "/suggest/setSuggest",
        headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json',
            "Authorization": localStorage.getItem('Authorization')
        },
        data: `{"customer_id":"${customer_id}","value_table": "${add_value}"}`,
        success: function (ingredients) {
            $(`#${id_datalist}`).empty();
    console.log("2set_options_datalist ", id_datalist)

            set_options_datalist(id_datalist.slice(id_datalist('_')+1,id_datalist.lastIndexOf('_')),add_value,id_datalist,5)

        },
        error: function (error) {
        },
    });
}


let arr_zaglav = [];
    document.getElementById('add_razdel').onclick = function () {
{#$("#style_table").style.display = 'block';#}
let e = document.getElementById("select_one");
let value = e.value;

 if(value == ''){
            e.setAttribute("required", true)
       } else if (arr_zaglav.indexOf(value) == -1){
        arr_zaglav.push(value)
        console.log(arr_zaglav)
        document.getElementById("style_table").style.display = "block";
        $("#first_table").append(`<tbody id = "earthWorks_${coll_table}">
                    <tr><td colspan="6" style="padding: 0;"><input id = 'zagolovok_${coll_table}' style = "width: 100%; height: 100%; border:  0;">
                               </td><td colspan="4" ><button id='del_razdel_${coll_table}' type="button" class="btn-primary"> Удалить раздел</button></td>
                    </tr>
                        <tr style="background-color: #fce1b3">
                            <td rowspan="2">Тех столбец</td>
                            <td>№</td>
                            <td rowspan="2">Наименование</td>
                            <td colspan="4">Стоимость</td>
                            <td colspan="4">Справочная информация</td>
                            <td colspan="8">Аналитический блок</td>
                        </tr>

                        <tr style="background-color: #fce1b3">
                            <td>п/п</td>
                            <td>Ед.изм.</td>
                            <td>Кол-во</td>
                            <td>Цена</td>
                            <td>Всего</td>
                            <td rowspan="1">Тр-затр (чел-дн)</td>
                            <td rowspan="1">Столбец для анализа</td>
                            <td rowspan="1"></td>
                            <td rowspan="1">Примечание</td>
                            <td>Кол-во</td>
                            <td>Цена руб-ед</td>
                            <td>Всего</td>
                            <td>Тр-затр (чел-дн)</td>
                            <td>Стоимость дня рабочего</td>
                        </tr>
                        </tbody>
                        <tbody id = 'earthWorks_costWork_${coll_table}'>
                        <tr>
                        <td></td>
                            <td contenteditable="false"></td>
                            <td contenteditable="false" id = 'earthWorks_costWork_addLine_${coll_table}' style="font-weight: bold;" colspan="4" onmouseover="showButton(event, this)" onmouseout="closeButton(event,this)">
                            Стоимость работ
                            <div style = "display: none"><button  onclick="addLine(event,this)">addLine</button></div>
                            </td>
                            <td contenteditable="true"></td>


                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                        </tr>
                    <tbody id = 'earthWorks_costMaterial_${coll_table}'>
                        <tr>
                        <td></td>
                            <td contenteditable="false"></td>
                            <td contenteditable="false" id = 'earthWorks_costMaterial_addLine_${coll_table}' style="font-weight: bold;" colspan="4" onmouseover="showButton(event, this)" onmouseout="closeButton(event,this)">
                            Стоимость материала
                            <div style = "display: none"><button  onclick="addLine(event,this)">addLine</button></div>
                            </td>
                            <td contenteditable="true"></td>


                            <td contenteditable="false" colspan="2"> Ед изм расчётные </td>

                            <td contenteditable="false"> Ед изм (М2) для окраски </td>

                            <td contenteditable="true"></td>

                            <td contenteditable="false">Закупка по счету - ед изм расчётные</td>
                            <td contenteditable="false">Остаток закупки</td>
                            <td contenteditable="false">ед изм к закупке</td>
                            <td contenteditable="false">руб-ед</td>
                            <td contenteditable="true"></td>
                            <td contenteditable="false">Счёта</td>
                            <td contenteditable="false">Срок поставки</td>
                            <td contenteditable="false">ПРИМЕЧАНИЕ</td>
                        </tr>
                    </tbody>

                    <tbody id = 'earthWorks_Special_${coll_table}'>
                    <tr>
                    <td></td>
                            <td contenteditable="false"></td>
                             <td contenteditable="false" id = 'earthWorks_Special_addLine_${coll_table}' style="font-weight: bold;" colspan="4" onmouseover="showButton(event, this)" onmouseout="closeButton(event,this)">
                            Стоимость спецтехники
                            <div style = "display: none"><button  onclick="addLine(event,this)">addLine</button></div>
                            </td>
                            <td contenteditable="true"></td>


                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>

                            <td contenteditable="true"></td>

                            <td contenteditable="false">Стоимость аренды</td>
                            <td contenteditable="false">Телефон</td>
                            <td contenteditable="false">Счет</td>
                            <td contenteditable="false">Срок</td>

                        </tr>

                    </tbody>

                     <tbody id = 'earthWorks_Total_${coll_table}'>
                        <tr>
                        <td></td>
                            <td contenteditable="false"></td>
                            <td contenteditable="false" style="font-weight: bold;" colspan="4"> Итого
                            </td>


                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>


                        </tr>
                        <tr id = "stroka">
                        <td></td>
                            <td contenteditable="false"></td>
                            <td contenteditable="false">
                                Накладные расходы
                            </td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>



                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>


                        </tr>

                        <tr id = "stroka">
                        <td></td>
                            <td contenteditable="false"></td>
                            <td contenteditable="false">
                                Вспомогательные материалы
                            </td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>



                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>


                        </tr>

                        <tr id = "stroka">
                        <td></td>
                            <td contenteditable="false"></td>
                            <td contenteditable="false">
                                Транспортные расходы
                            </td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>



                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>


                        </tr>

                        <tr id = "stroka">
                        <td></td>
                            <td contenteditable="false"></td>
                            <td contenteditable="false" style="font-weight: bold; text-align: right">
                                ВСЕГО:
                            </td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>



                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>

                        </tr>
                        <tr id = "stroka">
                        <td></td>
                            <td contenteditable="false"></td>
                            <td contenteditable="false" style="font-weight: bold;">
                                В том числе НДС - 20% за нал от материалов
                            </td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>


                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>
                            <td contenteditable="true"></td>

                        </tr>
                    </tbody>`)

                    document.getElementById(`zagolovok_${coll_table}`).setAttribute('value', value);

        document.getElementById(`del_razdel_${coll_table}`).onclick = function (event){
        console.log('eventDel_razdel ' + event.target.id.slice(event.target.id.lastIndexOf('_')+1))

            let zaglav = document.getElementById(`zagolovok_${event.target.id.slice(event.target.id.lastIndexOf('_')+1)}`);
            zaglav = zaglav.value;
            arr_zaglav.splice(arr_zaglav.indexOf(zaglav), 1);

            let cifra = event.target.id.slice(event.target.id.lastIndexOf('_')+1);
            arr_coll_table.splice(arr_coll_table.indexOf(Number(event.target.id.slice(event.target.id.lastIndexOf('_')+1))),1)
            console.log(arr_zaglav);

         document.getElementById(`earthWorks_${event.target.id.slice(event.target.id.lastIndexOf('_')+1)}`).remove()
         document.getElementById(`earthWorks_costWork_${event.target.id.slice(event.target.id.lastIndexOf('_')+1)}`).remove()
         document.getElementById(`earthWorks_costMaterial_${event.target.id.slice(event.target.id.lastIndexOf('_')+1)}`).remove()
         document.getElementById(`earthWorks_Special_${event.target.id.slice(event.target.id.lastIndexOf('_')+1)}`).remove()
         document.getElementById(`earthWorks_Total_${event.target.id.slice(event.target.id.lastIndexOf('_')+1)}`).remove()
        let arr_test = []
        $(`#first_table tbody`).each(function () {
                    arr_test.push(this.id);
                });
                console.log('arr_test = ' + arr_test.length)
        if (arr_test.length == 0){
        document.getElementById('style_table').style.display = 'none'}
        counterTr();
        }


        coll_table++;
        arr_coll_table.push(coll_table);
        console.warn('counterTr(); из add_razdel')
        counterTr();
        }
        else {alert('Заголовок есть')}
        }

 function counterTr(){
let arr_tbody = [];
let arr_tr = [];
let last_index = 0;
let razdelov = 0;

                $(`#first_table tbody`).each(function () {
                    arr_tbody.push(this.id);
                });
                if (arr_tbody.length >= 5){
          razdelov = arr_tbody.length / 5;
          console.warn('razdelov v tablice = ', razdelov)
          console.warn('arr_tbody = ', arr_tbody)
          }
                {# собрать все цифры после '_' в массив и подствить в for 'J'#}
                {#console.warn('arr_tbody = ' , arr_tbody,' arr_tbody.length = ' , arr_tbody.length);#}
for(let j = 1; j <= razdelov; j++){
arr_tr = [];
for (let i of arr_tbody){
{#if (i.slice(0, i.lastIndexOf('_')) = 'earthWorks')#}
if (i.slice(0, i.lastIndexOf('_')) != 'earthWorks'){
if(i.slice(i.lastIndexOf('_')+1, i.length) == arr_coll_table[j-1]){
$(`#${i} tr`).each(function () {
                    {#this.firstElementChild.innerHTML = arr_tr.length + 1;#}
                    this.childNodes[3].innerHTML = arr_tr.length + 1;
                    arr_tr.push(this.parentElement.id.slice(this.parentElement.id.lastIndexOf('_')+1));
          });
          console.log('arr_tr = ' + arr_tr)
          }
}
}
}
}

$(document).on('change', 'input', function () {
        let val = $(this).val();
        console.warn(val);
        console.warn($(this)[0].list.id);
        $(this)[0].setAttribute('value', val); {# добавляется атрибут value в изменяемый input#}
        let options_id = $(this)[0].list.id
        let options = $(`datalist#${options_id}`)[0].options;
        console.warn(options);
  });

    table.addEventListener('click', function handleClick(event) {
        if (event.target.type == 'button' && (event.target.id.slice(0,event.target.id.lastIndexOf('_')) == 'button_table_2' || event.target.id.slice(0,event.target.id.lastIndexOf('_')) == 'button_table_1')){
            let str = event.target.id.slice(event.target.id.lastIndexOf('_')+1, event.target.id.length);
            addLineString(str, event.target.id, id_count);
            id_count++;
            arr_id_count.push(id_count);
        } else if (event.target.type == 'button' && event.target.id.slice(0,event.target.id.lastIndexOf('_')) == 'delbtn'){
        console.warn('tyt', event.target.id)
            delLine(event.target.id);
        }

});



    function delLine(cel){
        console.warn('cel= ' + cel)
        let id_table = document.getElementById(cel).parentElement.parentElement.parentElement.id;
        id_table = id_table.slice(id_table.lastIndexOf('_')+1,id_table.length)
        console.log('tbody = ' + id_table)
        let id_del = cel.slice(cel.lastIndexOf('_')+1, cel.length)
        console.warn(id_del)
        console.warn(document.getElementById('stroka_' + id_del))
        document.getElementById(`stroka_${id_del}`).remove()

                console.warn('counterTr(); из Del_line')
                counterTr();
    }

$("#div1").delegate(":input", "input", function (e) {
let forObj = 'ListRazdel'
let type = forObj;
let id_count=e.target.id;
console.log("stroka = " + " #datalist_" + forObj + "_"+id_count)
    var options = $(`#${forObj}`)[0].options;
    console.log("options = " + options)
    if (options.length != 0 && options[options.length - 1].value == $(this).val()) {
    console.log('tyt1')
        if ($(this).val().indexOf("Добавить в список \"") != -1) {
            set_setSuggest(type, $(this).val().replace("Добавить в список \"", "").slice(0, -1),`${forObj}`)
            $(`#${forObj}`).val($(this).val().replace("Добавить в список \"", "").slice(0, -1));
        }
        return
    }
    set_options_datalist(type, e.target.value, forObj, 5)

});


</script>
