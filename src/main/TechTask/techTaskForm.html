<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
       {% include "indexShablon_head.html" %}

</head>

<body>
<div id="wrapper">
    <nav class="navbar navbar-default top-navbar" role="navigation">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../index.html">Dynamic_Kharkov</a>
        </div>

    </nav>
    <!--/. NAV TOP  -->
    <nav class="navbar-default navbar-side" role="navigation">
        <div class="sidebar-collapse">
            <ul class="nav" id="main-menu">

                <li>
                    <a class="active-menu" href="../index.html"><i class="fa fa-desktop"></i>Главная страница</a>
                </li>

                <li>
                    <a class="active-menu" href="techTask.html"><i class="fa fa-desktop"></i>Технические задания</a>
                </li>

            </ul>

        </div>

    </nav>

    <div id="page-wrapper">
        <div id="page-inner">
            <div class="row">
                <div class="col-md-12">
                    <h1 class="page-header">
                        Создание технического задания
                    </h1>
                </div>
            </div>


            <!-- /. ROW  -->
            <div class="row">
                <div class="col-lg-12">

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Список полей
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <div class="col-lg-12">
                                    <form role="form" id="formFrame">
                                        <div class="form-group">
                                            <label>Наименнование заказчика</label>
                                            <input name="TechTaskClient" value="" class="form-control"
                                                   placeholder="Введите описание">
                                        </div>


                                        <div class="form-group">
                                            <label>Наименнование объекта</label>
                                            <input name="NameTechTask" class="form-control"
                                                   placeholder="Введите описание">
                                        </div>

                                        <div name="TechTaskProject_form" class="form-group">
                                            <label>Проект/чертеж</label>
                                            <!--                                            <form id="myForm" action="/submit" method="post">-->

                                            <input name="TechTaskProject" type="file" id="file" name="file"/>
                                            <!--                                            </form>-->

                                        </div>
                                        <!--    <form id="myForm" action="/submit" method="post">-->
                                        <!--      <input type="file" onclick="submitForm(event)">-->
                                        <!--&lt;!&ndash;      <input type="submit" value="Отправить" onclick="submitForm(event)">&ndash;&gt;-->
                                        <!--    </form>-->

                                        <script>
                                            let vlozheniya = []
window.vlozheniya=vlozheniya
                                            document.getElementById('file').onchange = function () {
                                                console.log(5645123)
                                                const fileInput = document.getElementById('file'); // получаем элемент input для загрузки файла
                                                const file = fileInput.files[0]; // получаем выбранный файл

                                                const xhr = new XMLHttpRequest(); // создаем объект XMLHttpRequest
                                                const formData = new FormData(); // создаем объект FormData для передачи файла

                                                formData.append('file', file); // добавляем файл в объект FormData
                                                file_name = this.value.replace(/.*[\/\\]/, '');
                                                console.log(file_name)
                                                xhr.open('POST', '/BaseFile/uploadfile'); // указываем метод и URL сервера, куда будет отправлен файл
                                                xhr.setRequestHeader("Authorization", localStorage.getItem('Authorization')); // указываем метод и URL сервера, куда будет отправлен файл
                                                xhr.send(formData);
                                                xhr.onload = function () {
                                                    console.log(`Загружено: ${xhr.status} ${xhr.response}`);
                                                    if (xhr.status == 200) {
                                                        vlozheniya.push({
                                                            name: file_name,
                                                            id: xhr.response.replaceAll('"', "")
                                                        })
                                                        div = document.createElement('div')
                                                        a = document.createElement('a')
                                                        a.href = 'javascript:void(0);'
                                                        a.target = "_blank"
                                                        a.onclick = function () {
                                                            event.preventDefault();
                                                            downloadFileFromURL('/BaseFile/download-file/' + xhr.response.replaceAll('"', ""), file_name)
                                                        }
                                                        a.innerText = file_name
                                                        div.append(a)
                                                        document.getElementsByName('TechTaskProject_form')[0].append(div)

                                                        // <a href='javascript:void(0);' target="_blank" onclick="event.preventDefault();downloadFileFromURL('/BaseFile/download-file/6d3d286e-4ab5-4f69-afdc-952a7d98137f', 'Бросить кубики онлайн.html')">Бросить кубики онлайн.html</a>

                                                    }
                                                    // $('input[name="TechTaskProject"]').prop('files')[0]["id"] = $('input[name="TechTaskProject"]').prop('files')[0]["id"].append(xhr.response)

                                                }
                                            }

                                            // $("#TechTaskProject").prop('files')[0]["id"]="iddddd"// отправляем запрос на сервер с помощью метода send()
                                            // fire the upload here

                                            function submitForm(event) {
                                                event.preventDefault(); // Предотвращаем обновление страницы
                                                console.log(123)
                                                // let form = document.getElementById("myForm");
                                                // let formData = new FormData(form);
                                                //
                                                // // Отправка данных формы с помощью AJAX-запроса
                                                // let xhr = new XMLHttpRequest();
                                                // xhr.open("POST", form.action, true);
                                                // xhr.send(formData);
                                            }
                                        </script>
                                        <div class="form-group">
                                            <label>ППР (проект производства работ)</label>
                                            <textarea name="TechTaskPPR" class="form-control" rows="3"
                                                      placeholder="Введите описание"></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label>Накладные расходы на объекте</label>
                                            <textarea name="TechTaskOverhead" class="form-control" rows="3"
                                                      placeholder="Введите описание"></textarea>
                                        </div>


                                        <div class="row">
                                            <div class="form-group col-lg-3">
                                                <label>Срок подготовки коммерческого предложения</label>
                                                <input name="TechTaskDateKP" type="datetime-local" class="form-control"
                                                       placeholder="dd.mm.yyyy">
                                            </div>

                                            <div class="form-group col-lg-3">
                                                <label>Срок выполнения работ</label>
                                                <input name="TechTaskDateEndWork" type="datetime-local"
                                                       class="form-control"
                                                       placeholder="dd.mm.yyyy">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label>Условия оплаты</label>
                                            <textarea name="TechTaskPrice" class="form-control" rows="3"
                                                      placeholder="Введите описание"></textarea>
                                        </div>

                                        <div class="form-group">
                                            <label>Ответственный за КП</label>
                                            <select name="TechTaskLeaderKP" class="form-control">
                                                <option>Главный инженер</option>
                                                <option>Технический директор</option>
                                                <option>Снабжение</option>
                                                <option>ПТО</option>
                                                <option>Директор</option>
                                            </select>
                                        </div>

                                        <button id="createTicket">Создать задание</button>
                                        <script>
                                            let elem_obj = {}
                                            elem_obj.TechTaskProject = JSON.stringify(window.vlozheniya)
                                                console.log('client0', elem_obj)

                                            function validForm(obj) {
                                                console.log('validForm', obj)
                                                let valid = true
                                                let elements = $('form').serializeArray();
                                                console.log('client1', elements)
                                                for (let key of elements) {
                                                    elem_obj[key.name] = key.value
                                                    if (key.value == '' || key.value == '[]') {
                                                        valid = false
                                                        console.warn(key, key.name, key.value)
                                                        document.getElementsByName(key.name)[0].setAttribute("required", true)
                                                    } else {
                                                        document.getElementsByName(key.name)[0].removeAttribute("required")
                                                    }

                                                }
                                                if (window.vlozheniya.length==0) {
                                                    valid = false
                                                        console.warn('TechTaskProject',window.vlozheniya)
                                                    document.getElementsByName('TechTaskProject')[0].setAttribute("required", true)
                                                }

                                                return valid
                                            }

                                            document.getElementById('createTicket').onclick = function (event) {
                                                if (validForm(document.getElementById('formFrame'))) {

                                                    event.preventDefault()
                                                    // Определяем функцию которая принимает в качестве параметров url и данные которые необходимо обработать:
                                                    const postData = async (url = '', data = {}) => {
                                                        // Формируем запрос
                                                        data.TechTaskProject = JSON.stringify(JSON.stringify(window.vlozheniya))

                                                        const response = await fetch(url, {
                                                            // Метод, если не указывать, будет использоваться GET
                                                            method: 'POST',
                                                            // Заголовок запроса
                                                            headers: {
                                                                "Authorization": localStorage.getItem('Authorization'),
                                                                'Content-Type': 'application/json'
                                                            },
                                                            // Данные
                                                            body: JSON.stringify(data)
                                                        });
                                                        return response.json();
                                                    }
                                                    postData('http://127.0.0.1:8000/main/creatTask', elem_obj)
                                                        .then((data) => {
                                                            console.log('------успех-----', data);
                                                            window.location.href = '/main/techTask.html';
                                                        }).catch((err) => {
                                                        console.log('------badly-----', err);
                                                    })

                                                } else {
                                                    event.preventDefault()
                                                }
                                            }
                                        </script>
                                    </form>

                                </div>
                                <!-- /.col-lg-6 (nested) -->
                                <!-- /.col-lg-6 (nested) -->
                            </div>
                            <!-- /.row (nested) -->
                        </div>
                        <!-- /.panel-body -->
                    </div>
                    <!-- /.panel -->
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <footer><p>All right reserved. Template by: <a href="http://webthemez.com">WebThemez</a></p></footer>
        </div>
        <!-- /. PAGE INNER  -->
    </div>
    <!-- /. PAGE WRAPPER  -->
</div>

    {% include "indexShablon_end.html" %}



</body>

</html>