<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    {% include "indexShablon_head.html" %}

</head>

<body>

<div id="wrapper">
    {% include "indexShablon.html" %}
    <div id="page-wrapper">
        <div id="page-inner">
            <div class="row">

                <section class="vh-100 gradient-custom-2">
                    <div class="container py-5 h-100">
                        <div class="row d-flex justify-content-center align-items-center h-100">
                            <div class="col-md-12 col-xl-10">

                                <div class="card mask-custom">
                                    {#                                    <ta class="card-body p-4 text-white">#}

                                    <div class="text-center pt-3 pb-2">
                                        <img src="{{ url_for('static', path='auth/images/check1.webp') }}"
                                             alt="Check" width="60">
                                        <h3 class="my-4">СПИСОК ЗАДАЧ</h3>
                                    </div>
                                    <div class="text-center pt-3 pb-2">

                                    </div>

                                    <table class="table text-white mb-0">
                                        <thead>
                                        <tr>
                                            <th scope="col">НАЗВАНИЕ ЗАДАЧИ</th>
                                            <th scope="col">АВТОР</th>
                                            <th scope="col">ИСПОЛНИТЕЛИ</th>
                                            <th scope="col">ДАТА НАЗНАЧЕНИЯ/КОНТРОЛЬНЫЙ СРОК</th>
                                            <th scope="col">ПРИОРИТЕТ</th>
                                            <th scope="col">СТАТУС</th>
                                            <th scope="col">РЕШЕНИЕ</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <script>


                                            async function Get_user() {
                                                check_user = await fetch('/auth/get_UserPfofile', {
                                                    method: 'POST',
                                                    headers: {
                                                        "Accept": 'application/json',
                                                        "Content-Type": 'application/json',
                                                        "Authorization": getCookieValue("Authorization")
                                                    },
                                                    body: JSON.stringify({"username": "admin"})
                                                });
                                                let responseText = await check_user.text();
                                                console.log(responseText)
                                            }

                                            Get_user()
                                            {#console.log({{ get_UserTask|tojson|safe}}.length)#}

                                            {#document.getElementById("Header_show").innerHTML = '<i class="fa fa-bell fa-fw"></i>' + Header_show_value#}
                                        </script>
                                        {% for get_UserTask_for in get_UserTask %}

                                            <tr class="mark">

                                                {#НАЗВАНИЕ ЗАДАЧИ#}
                                                <th>
                                                    <span id="name_tasc_{{ get_UserTask_for.id }}"
                                                          class="ms-2">{{ get_UserTask_for.name }}</span>
                                                </th>

                                                {#АВТОР#}
                                                <td class="align-middle">
                                                    <span>{{ get_UserTask_for.UserPfofile_create.first_name }} {{ get_UserTask_for.UserPfofile_create.last_name }}</span>
                                                </td>


                                                {#ИСПОЛНИТЕЛИ#}
                                                <td class="align-middle">
                                                    {#                                                    <span>{{ get_UserTask_for.UserPfofile_executor }}</span>#}
                                                    {#                                                    <span>{{ get_UserTask_for.UserPfofile_executor  }}</span>#}

                                                    {% for UserPfofile_executor_for in get_UserTask_for.UserPfofile_executor %}
                                                        <span>{{ UserPfofile_executor_for.first_name }} {{ UserPfofile_executor_for.last_name }},</span>

                                                    {% endfor %}

                                                </td>

                                                {#ДАТА НАЗНАЧЕНИЯ#}
                                                <td class="align-middle">
                                                    <span>{{ get_UserTask_for.create_at }}/{{ get_UserTask_for.target_date }}</span>

                                                </td>


                                                {#ПРИОРИТЕТ#}
                                                <td class="align-middle">
                                                    <h6 class="mb-0">

                                                        {% if get_UserTask_for.priority|lower == "Важно"|lower %}
                                                            <span class="badge bg-danger">{{ get_UserTask_for.priority }}</span>
                                                        {% elif get_UserTask_for.priority|lower == "Нормально"|lower %}
                                                            <span class="badge bg-warning">{{ get_UserTask_for.priority }}</span>
                                                        {% else %}
                                                            <span class="badge bg-success">{{ get_UserTask_for.priority }}</span>
                                                        {% endif %}
                                                    </h6>
                                                </td>

                                                {#CТАТУС#}
                                                <td class="align-middle">
                                                    <span id="status_{{ get_UserTask_for.id }}">{{ get_UserTask_for.status }}</span>

                                                </td>

                                                {#РЕШЕНИЕ#}
                                                <td class="align-middle">
                                                    <span id="result_value_{{ get_UserTask_for.id }}">{{ get_UserTask_for.result }}</span>

                                                    {% if get_UserTask_for.status|lower == "В Работе"|lower or  get_UserTask_for.status|lower == "Назначена"|lower %}


                                                        {% if get_UserTask_for.notification_executor|lower == "false"|lower %}
                                                            <button id="process_{{ get_UserTask_for.id }}">Выполнить
                                                                задачу
                                                            </button>
                                                        {% else %}
                                                            <button id="process_{{ get_UserTask_for.id }}">Взять в
                                                                работу
                                                            </button>
                                                        {% endif %}
                                                    {% else %}
                                                        <button style="display: none;"
                                                                id="process_{{ get_UserTask_for.id }}">Взять в работу
                                                        </button>
                                                    {% endif %}


                                                </td>


                                                <div id="overlay"></div>
                                                <div class="container">


                                                    <div id="popup" class="popup">
                                                        <!--  Создадим div, в который обернем заголовок и кнопки, а затем применем стили -->
                                                        <div class="popup__content">
                                                            <h2 class="popup__title">
                                                                Результат работы
                                                            </h2>

                                                            <label>Код закрытия</label>
                                                            <select id="kod" class="form-control">
                                                                <option>Выполнено</option>
                                                                <option>Отказ выполнять</option>
                                                            </select>

                                                            <label>Решение</label>
                                                            <textarea id="result" class="form-control" rows="3"
                                                                      placeholder="Введите резултаты работы"></textarea>
                                                        </div>
                                                        <div class="btn-container">

                                                            <button id="yes-btn" class="popup__button">
                                                                Сохранить
                                                            </button>
                                                            <button id="no-btn" class="popup__button">
                                                                Отмена
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div id="success" class="popup">
                                                    <!--  Создадим div, в который обернем заголовок и кнопки, а затем применем стили -->
                                                    <div class="popup__content">
                                                        <h2 class="popup__title">
                                                            Выполнено
                                                        </h2>
                                                        <svg class="checkmark" viewBox="0 0 52 52">
                                                            <circle class="checkmark__circle" cx="26" cy="26" r="25"
                                                                    fill="none"/>
                                                            <path class="checkmark__check" fill="none"
                                                                  d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                                                        </svg>

                                                        {##}
                                                        {#                                                        <svg viewBox="0 0 130.2 130.2">#}
                                                        {#                                                            <circle class="path circle" fill="none" stroke="#D06079"#}
                                                        {#                                                                    stroke-width="6" stroke-miterlimit="10" cx="65.1"#}
                                                        {#                                                                    cy="65.1" r="62.1"/>#}
                                                        {#                                                            <line class="path line" fill="none" stroke="#D06079"#}
                                                        {#                                                                  stroke-width="6" stroke-linecap="round"#}
                                                        {#                                                                  stroke-miterlimit="10" x1="34.4" y1="37.9" x2="95.8"#}
                                                        {#                                                                  y2="92.3"/>#}
                                                        {#                                                            <line class="path line" fill="none" stroke="#D06079"#}
                                                        {#                                                                  stroke-width="6" stroke-linecap="round"#}
                                                        {#                                                                  stroke-miterlimit="10" x1="95.8" y1="38" x2="34.4"#}
                                                        {#                                                                  y2="92.2"/>#}
                                                        {#                                                        </svg>#}
                                                        <button id="good" class="popup__button">
                                                            Отлично
                                                        </button>

                                                    </div>
                                                </div>
                                            </tr>
                                        {% endfor %}

                                    </table>
                                </div>
                                <label id="Type_label">Создание новой задачи</label>

                                <div class="form-group">
                                    <label id="Type_label">Выбор пользователей</label>
                                    <select id="Type" class="form-control">
                                        <option value="">--Выберите значение--</option>
                                        <option value="username">По имени</option>
                                        <option value="roles">По роли</option>

                                    </select>
                                </div>

                                <div class="form-group" id="Otpravka_roles_forms" style="display:none;">
                                    <label id="Otpravka_roles_label">На кого будет назначено. Все
                                        пользователи/роли </label>
                                    <select id="Otpravka_roles" class="form-control">

                                    </select>
                                </div>

                                <div class="form-group" id="Opisanie_forms" style="display:none;">
                                    <label id="Otpravka_roles_label_comment">Описание выполненых работ</label>
                                    <textarea id="Otpravka_roles_text" class="form-control" rows="3"
                                              placeholder="Введите описание"></textarea>

                                    <label id="Type_label">Приоритет</label>
                                    <select id="priority" class="form-control">
                                        <option value="Не важно">Не важно</option>
                                        <option value="Нормально">Нормально</option>
                                        <option value="Важно">Важно</option>
                                    </select>
                                    <label>Срок выполнения работ</label>
                                    <input id="DateEndWork" type="date"
                                           class="form-control"
                                           placeholder="dd.mm.yyyy">
                                </div>
                                <div class="form-group" id="button_forms" style="display:none;">

                                    <button id="Otpravka_roles_button" class="btn btn-primary">Подтвердить отправку
                                    </button>

                                </div>
                                <script>

                                    document.getElementById("Otpravka_roles_text").onkeypress = function (e) {
                                        var chr = String.fromCharCode(e.which);
                                        if ("&".indexOf(chr) != -1)
                                            return false;
                                    };
                                    document.getElementById('Otpravka_roles_button').onclick = async function () {
                                        event.preventDefault();
                                        valid = true
                                        if (document.getElementById('Otpravka_roles_text').value == "") {
                                            valid = false
                                            document.getElementById('Otpravka_roles_text').setAttribute("required", true)
                                        }
                                        if (document.getElementById('DateEndWork').value == "") {
                                            valid = false
                                            document.getElementById('DateEndWork').setAttribute("required", true)

                                        }
                                        if (valid == false) {
                                            return
                                        }
                                        else {
                                            console.log(document.getElementById('Otpravka_roles_text').value)
                                            user = []
                                            user.push(document.getElementById('Otpravka_roles').value)
                                            if (document.getElementById('Type').value=="username"){
                                               URL= `/userprofile/createUserTask?name=${document.getElementById('Otpravka_roles_text').value}&user_executor=${JSON.stringify(user)}&status=%D0%9D%D0%B0%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B0&result=&target_date=${document.getElementById('DateEndWork').value}&notification_holder=false&notification_executor=true&priority=${document.getElementById('priority').value}`
                                            }else{
                                               URL= `/userprofile/createUserTaskRoles?name=${document.getElementById('Otpravka_roles_text').value}&user_executor=${JSON.stringify(user)}&status=%D0%9D%D0%B0%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B0&result=&target_date=${document.getElementById('DateEndWork').value}&notification_holder=false&notification_executor=true&priority=${document.getElementById('priority').value}`
                                            }
                                            res = await fetch(URL, {
                                                method: "GET",
                                                headers: {
                                                    Accept: 'application/json',
                                                    'Content-Type': 'application/json',
                                                    "Authorization": getCookieValue("Authorization")
                                                },
                                                {#body: JSON.stringify({})#}
                                            });
                                            console.log("res.status", res.status)
                                            if (res.status == 200) {
                                                console.log(res.status)
                                                window.location.reload();
                                            } else {
                                                showToast("Ошибка", "error", 5000);

                                            }
                                        }
                                    }
                                    document.getElementById('Otpravka_roles').onchange = async function (event) {
                                        document.getElementById("Opisanie_forms").style.display = "block";
                                        document.getElementById("button_forms").style.display = "block";

                                    }
                                    document.getElementById('Type').onchange = async function (event) {
                                        event.preventDefault();

                                        removeOptions(document.getElementById('Otpravka_roles'));
                                        var opt = document.createElement('option');
                                        opt.innerHTML = "<option disabled selected value> --Выберите-- </option>"
                                        document.getElementById('Otpravka_roles').appendChild(opt);
                                        if ($(this).val() == "roles") {
                                            document.getElementById("Opisanie_forms").style.display = "none";
                                            document.getElementById("button_forms").style.display = "none";
                                            document.getElementById("Otpravka_roles_forms").style.display = "block";



                                            values = {{ all_roles|tojson|safe }}
                                            for (value of Object.keys(values)) {
                                                console.log("value", value)

                                                var opt = document.createElement('option');
                                                opt.value = value
                                                opt.innerHTML = values[value]
                                                document.getElementById('Otpravka_roles').appendChild(opt);


                                            }
                                        }

                                        if ($(this).val() == "username") {
                                            document.getElementById("Otpravka_roles_forms").style.display = "block";


                                            values = {{ all_user|tojson|safe }}
                                            for (value of Object.keys(values)) {
                                                console.log("value", value)

                                                var opt = document.createElement('option');
                                                opt.value = value
                                                opt.innerHTML = values[value]
                                                document.getElementById('Otpravka_roles').appendChild(opt);


                                            }
                                        }
                                    }

                                    async function updatde_UserTask(data, e, name_task, rezult_task) {
                                        console.log("datadata", data)
                                        console.log("datadata", e)
                                        console.log("useruseruseruser", window.get_UserTask[data.id.id - 1].user_create)
                                        let data_analiz = window.get_UserTask
                                        console.log("useruseruseruser", data_analiz)
                                        data_analiz.forEach(function (val, id) {
                                            if (val.id == data.id.id) {
                                                iskomiy_id = id
                                                console.log("111", val.name)
                                                console.log("111", val.user_create)
                                                return
                                            }
                                        })
                                        console.log("iskomiy_idiskomiy_id", iskomiy_id)
                                        res = await fetch('/userprofile/updateUserTasck', {
                                            method: "POST",
                                            headers: {
                                                Accept: 'application/json',
                                                'Content-Type': 'application/json',
                                                "Authorization": getCookieValue("Authorization")
                                            },
                                            body: JSON.stringify(data)
                                        });
                                        console.log("res.status", res.status)
                                        if (res.status == 200) {
                                            console.log("res.data", data)
                                            console.log("res.data", data["id"]["id"])

                                            document.getElementById("status_" + data["id"]["id"]).innerText = data["user_data"]["status"]


                                            if (data["user_data"]["status"] == "В Работе") {

                                                document.getElementById(e.target.id).innerText = "Выполнить задачу"
                                                showToast("Задача взята в работу", "info", 5000);
                                                String(e.target.id).slice(String(e.target.id).lastIndexOf("_") + 1)
                                                get_UserTask_global()
                                                send_telegram(data_analiz[iskomiy_id].user_create, `Задача <${name_task}> взята в работу`)

                                            } else {

                                                document.getElementById("process_" + data["id"]["id"]).style = "display: none;"
                                                document.getElementById("result_value_" + data["id"]["id"]).innerText = data["user_data"]["result"]
                                                send_telegram(data_analiz[iskomiy_id].user_create, `Задача <${name_task}> выполнена с решением: <${rezult_task}>`)

                                                document.getElementById("success").style.display = "block";
                                                document.getElementById("popup").style.display = "none";
                                                document.getElementById("overlay").classList.add("show");


                                            }


                                        } else {
                                            showToast("Ошибка", "error", 5000);

                                        }
                                    }

                                    window.get_UserTask = {{ get_UserTask|tojson|safe}}
                                    for (v of {{ get_UserTask|tojson|safe}}) {
                                        console.log("get_UserTask_for.id", v.id)
                                        console.log("get_UserTask_for.id", v)
                                        console.log("11111get_UserTask_for.id", {{ get_UserTask|tojson|safe}}[0]["user_create"])
                                        console.log("get_UserTask_for.id", document.getElementById("process_" + v.id))
                                        document.getElementById("process_" + v.id).addEventListener("click", (e) => {
                                            console.log("get_UserTask_for.id", e.target.id)
                                            console.log("get_UserTask_for.id", document.getElementById(e.target.id))

                                            if (document.getElementById(e.target.id).innerText == "Взять в работу") {

                                                data = {
                                                    "user_data": {
                                                        "status": "В Работе",
                                                        "result": "",
                                                        "notification_holder": false,
                                                        "notification_executor": false
                                                    },
                                                    "id": {
                                                        "id": e.target.id.replace("process_", "")
                                                    }
                                                }
                                                updatde_UserTask(data, e, document.getElementById("name_tasc_" + data["id"]["id"]).innerText)

                                                {#get_UserTask()#}
                                            } else {
                                                document.getElementById("popup").style.display = "block";
                                                document.getElementById("overlay").classList.add("show");
                                                document.getElementById("yes-btn").className += " " + String(e.target.id).slice(String(e.target.id).lastIndexOf("_") + 1)


                                            }

                                        });
                                    }


                                    document.getElementById("good").addEventListener("click", () => {
                                        document.getElementById("success").style.display = "none";
                                        document.getElementById("overlay").classList.remove("show");
                                    });

                                    document.getElementById("no-btn").addEventListener("click", () => {
                                        document.getElementById("popup").style.display = "none";
                                        document.getElementById("overlay").classList.remove("show");
                                    });

                                    document.getElementById("yes-btn").addEventListener("click", (e) => {

                                        console.log(document.getElementById("yes-btn").className.split(" ")[1])

                                        data = {
                                            "user_data": {
                                                "status": document.getElementById("kod").value,
                                                "result": document.getElementById("result").value,
                                                "notification_holder": true,
                                                "notification_executor": false
                                            },
                                            "id": {
                                                "id": document.getElementById("yes-btn").className.split(" ")[1]
                                            }
                                        }
                                        updatde_UserTask(data, e, document.getElementById("name_tasc_" + data["id"]["id"]).innerText, document.getElementById("result").value)


                                    });


                                </script>


                                {#                                <tr class="fw-normal">#}
                                {#                                    <th>#}
                                {#                                        <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava2-bg.webp"#}
                                {#                                             alt="avatar 1" style="width: 45px; height: auto;">#}
                                {#                                        <span class="ms-2">Kate Moss</span>#}
                                {#                                    </th>#}
                                {#                                    <td class="align-middle">Make payment to Bluedart</td>#}
                                {#                                    <td class="align-middle">#}
                                {#                                        <h6 class="mb-0"><span class="badge bg-success">Low priority</span>#}
                                {#                                        </h6>#}
                                {#                                    </td>#}
                                {#                                    <td class="align-middle">#}
                                {#                                        <a href="#!" data-mdb-toggle="tooltip" title="Done"><i#}
                                {#                                                class="fas fa-check fa-lg text-success me-3"></i></a>#}
                                {#                                        <a href="#!" data-mdb-toggle="tooltip" title="Remove"><i#}
                                {#                                                class="fas fa-trash-alt fa-lg text-warning"></i></a>#}
                                {#                                    </td>#}
                                {#                                </tr>#}
                                {#                                <tr class="fw-normal">#}
                                {#                                    <th>#}
                                {#                                        <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3-bg.webp"#}
                                {#                                             alt="avatar 1" style="width: 45px; height: auto;">#}
                                {#                                        <span class="ms-2">Danny McChain</span>#}
                                {#                                    </th>#}
                                {#                                    <td class="align-middle">Office rent</td>#}
                                {#                                    <td class="align-middle">#}
                                {#                                        <h6 class="mb-0"><span#}
                                {#                                                class="badge bg-warning">Middle priority</span></h6>#}
                                {#                                    </td>#}
                                {#                                    <td class="align-middle">#}
                                {#                                        <a href="#!" data-mdb-toggle="tooltip" title="Done"><i#}
                                {#                                                class="fas fa-check fa-lg text-success me-3"></i></a>#}
                                {#                                        <a href="#!" data-mdb-toggle="tooltip" title="Remove"><i#}
                                {#                                                class="fas fa-trash-alt fa-lg text-warning"></i></a>#}
                                {#                                    </td>#}
                                {#                                </tr>#}
                                {#                                <tr class="fw-normal">#}
                                {#                                    <th>#}
                                {#                                        <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava5-bg.webp"#}
                                {#                                             alt="avatar 1" style="width: 45px; height: auto;">#}
                                {#                                        <span class="ms-2">Alexa Chung</span>#}
                                {#                                    </th>#}
                                {#                                    <td class="align-middle">Office grocery shopping</td>#}
                                {#                                    <td class="align-middle">#}
                                {#                                        <h6 class="mb-0"><span class="badge bg-danger">High priority</span>#}
                                {#                                        </h6>#}
                                {#                                    </td>#}
                                {#                                    <td class="align-middle">#}
                                {#                                        <a href="#!" data-mdb-toggle="tooltip" title="Done"><i#}
                                {#                                                class="fas fa-check fa-lg text-success me-3"></i></a>#}
                                {#                                        <a href="#!" data-mdb-toggle="tooltip" title="Remove"><i#}
                                {#                                                class="fas fa-trash-alt fa-lg text-warning"></i></a>#}
                                {#                                    </td>#}
                                {#                                </tr>#}
                                {#                                <tr class="fw-normal">#}
                                {#                                    <th class="border-0">#}
                                {#                                        <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava6-bg.webp"#}
                                {#                                             alt="avatar 1" style="width: 45px; height: auto;">#}
                                {#                                        <span class="ms-2">Ben Smith</span>#}
                                {#                                    </th>#}
                                {#                                    <td class="border-0 align-middle">Ask for Lunch to Clients</td>#}
                                {#                                    <td class="border-0 align-middle">#}
                                {#                                        <h6 class="mb-0"><span class="badge bg-success">Low priority</span>#}
                                {#                                        </h6>#}
                                {#                                    </td>#}
                                {#                                    <td class="border-0 align-middle">#}
                                {##}
                                {#                                                    <a href="#!"><i class="fa fa-bell fa-10x" ></i></a>#}
                                {#                                        <a href="#!"><i class="fa fa-camera-retro fa-10x"></i></a>#}
                                {#                                        <a href="#!"><i class="fa fa-home fa-10"></i></a>#}
                                {#    <div><i class="fa fa-envelope"></i> - envelope icon</div>#}
                                {#    <div> <i class="fa fa-phone"></i> - phone icon</div>#}
                                {#    <div> <i class="fa fa-search"></i> - search icon</div>#}
                                {#    <div><i class="fa fa-shopping-cart"></i> - shopping cart icon</div>#}
                                {#    <div> <i class="fa fa-user"></i> - user icon</div>#}
                                {#    <div> <i class="fa fa-heart"></i> - heart icon</div>#}
                                {#    <div><i class="fa fa-play"></i> - play icon</div>#}
                                {#    <div> <i class="fa fa-cog"></i> - cog/gear icon</div>#}
                                {#    <div><i class="fa fa-home"></i> - trash icon</div>#}
                                {#    <div> <i class="fa fa-check"></i> - checkmark icon</div>#}
                                {#                                    </td>#}
                                {#                                </tr>#}
                                </tbody>
                                </table>


                            </div>
                        </div>

                    </div>
            </div>
        </div>
        </section>
    </div>
</div>
<!-- /. PAGE INNER  -->
</div>
<!-- /. PAGE WRAPPER  -->
</div>

{% include "indexShablon_end.html" %}

<!-- Создадим контейнер, чтобы спозиционировать элементы интерфейса на экране -->


</body>

</html>

